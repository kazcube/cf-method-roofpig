<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAZCUBE Lab - Ver 5.0 Paint & Validate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.cubing.net/v0/js/cubing/twisty" type="module"></script>
    <style>
        twisty-player { touch-action: none; width: 100%; height: 100%; }
        .color-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #334155; cursor: pointer; transition: transform 0.2s; }
        .color-dot.active { transform: scale(1.3); border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .diagnostic-area { min-height: 40px; }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 p-4">
    <div class="max-w-4xl mx-auto bg-slate-800 rounded-3xl p-6 border border-slate-700 shadow-2xl">
        <header class="mb-6 flex justify-between items-center border-b border-slate-700 pb-3">
            <div class="flex items-baseline gap-3">
                <h2 class="text-2xl font-black text-emerald-400 tracking-tighter">KAZCUBE Lab</h2>
                <span class="text-[10px] font-mono text-slate-500 bg-slate-900 px-2 py-0.5 rounded border border-slate-700 uppercase">v5.0 Paint_Base</span>
            </div>
            <div id="mode-badge" class="text-xs font-mono bg-blue-900 text-blue-200 px-3 py-1 rounded-full border border-blue-500/30 uppercase tracking-widest">Rotate Mode</div>
        </header>

        <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
                <div class="bg-black rounded-3xl aspect-square border-4 border-slate-700 overflow-hidden shadow-inner relative" id="cube-container">
                    <twisty-player id="main-cube" puzzle="3x3x3" background="none" control-panel="none" visualization="3D"></twisty-player>
                </div>
                
                <div class="diagnostic-area p-3 rounded-xl bg-slate-900 border border-slate-700 flex flex-col justify-center">
                    <div id="validator-msg" class="text-xs font-bold text-emerald-500 flex items-center gap-2">
                        <span>✅ Valid Sticker Count</span>
                    </div>
                    <div id="error-list" class="text-[10px] text-red-400 mt-1 space-y-0.5"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="flex bg-slate-900 p-1 rounded-2xl border border-slate-700">
                    <button id="mode-rotate" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all bg-emerald-600 text-white shadow-lg">ROTATE</button>
                    <button id="mode-paint" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all text-slate-400">PAINT</button>
                </div>

                <div id="palette-container" class="space-y-3 opacity-30 pointer-events-none transition-opacity">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Select Color</label>
                    <div class="flex flex-wrap gap-3 p-4 bg-slate-900 rounded-2xl border border-slate-700" id="palette">
                        <div class="color-dot active" data-color="white" style="background: #ffffff;"></div>
                        <div class="color-dot" data-color="yellow" style="background: #fbbf24;"></div>
                        <div class="color-dot" data-color="red" style="background: #ef4444;"></div>
                        <div class="color-dot" data-color="orange" style="background: #f97316;"></div>
                        <div class="color-dot" data-color="blue" style="background: #3b82f6;"></div>
                        <div class="color-dot" data-color="green" style="background: #22c55e;"></div>
                        <div class="color-dot" data-color="gray" style="background: #64748b;"></div> </div>
                </div>

                <div class="space-y-2">
                    <textarea id="command-box" class="w-full h-24 bg-black/50 text-emerald-500 p-3 rounded-xl font-mono text-xs border border-slate-700 outline-none focus:border-emerald-500 transition-all resize-none" placeholder="Scramble or Solve sequence..."></textarea>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-scramble" class="py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold text-[10px] uppercase">Scramble</button>
                        <button id="btn-setup" class="py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 rounded-xl font-bold text-[10px] uppercase">Set to Solve</button>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-1" id="move-grid"></div>

                <button id="btn-reset" class="w-full py-2 bg-slate-700 hover:bg-red-900/50 text-slate-300 rounded-xl text-[10px] font-bold transition-all border border-slate-600">RESET CUBE & PAINT</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { TwistyPlayer } from "https://cdn.cubing.net/v0/js/cubing/twisty";

        const player = document.getElementById('main-cube');
        const cmdBox = document.getElementById('command-box');
        const validatorMsg = document.getElementById('validator-msg');
        const errorList = document.getElementById('error-list');
        const modeBadge = document.getElementById('mode-badge');
        
        let currentMode = 'rotate'; // 'rotate' or 'paint'
        let selectedColor = 'white';
        
        // --- Sticker State Management ---
        // We'll track custom colors in an object: { "face_index": "color" }
        let customStickering = {};

        // --- Palette Logic ---
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.onclick = () => {
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                dot.classList.add('active');
                selectedColor = dot.dataset.color;
            };
        });

        // --- Mode Switching ---
        const btnRotate = document.getElementById('mode-rotate');
        const btnPaint = document.getElementById('mode-paint');
        const paletteContainer = document.getElementById('palette-container');

        btnRotate.onclick = () => setMode('rotate');
        btnPaint.onclick = () => setMode('paint');

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'rotate') {
                btnRotate.className = "flex-1 py-2 rounded-xl text-xs font-bold transition-all bg-emerald-600 text-white shadow-lg";
                btnPaint.className = "flex-1 py-2 rounded-xl text-xs font-bold transition-all text-slate-400";
                paletteContainer.style.opacity = "0.3";
                paletteContainer.style.pointerEvents = "none";
                modeBadge.textContent = "Rotate Mode";
                modeBadge.className = "text-xs font-mono bg-blue-900 text-blue-200 px-3 py-1 rounded-full border border-blue-500/30 uppercase tracking-widest";
                player.style.pointerEvents = "auto";
            } else {
                btnPaint.className = "flex-1 py-2 rounded-xl text-xs font-bold transition-all bg-orange-600 text-white shadow-lg";
                btnRotate.className = "flex-1 py-2 rounded-xl text-xs font-bold transition-all text-slate-400";
                paletteContainer.style.opacity = "1";
                paletteContainer.style.pointerEvents = "auto";
                modeBadge.textContent = "Paint Mode";
                modeBadge.className = "text-xs font-mono bg-orange-900 text-orange-200 px-3 py-1 rounded-full border border-orange-500/30 uppercase tracking-widest";
                // In paint mode, we actually want to intercept clicks on the canvas
            }
        }

        // --- Painting Logic ---
        player.addEventListener('click', (e) => {
            if (currentMode !== 'paint') return;
            // The twisty-player doesn't easily expose which sticker was clicked.
            // We'll use the experimental customStickering property.
            // For Step 1, we use a prompt-based or coordinate-based approach is hard.
            // Let's use the property-based approach via the console or UI.
            // Actually, twisty-player supports experimental-stickering-mask
        });

        // For Ver 5.0, since direct sticker-click event is complex in the library, 
        // we'll implement a 'Color Assignment' logic by checking the player state.
        // We will override colors by applying a mask that we update.
        
        async function updateStickers() {
            // This is the core engine for Ver 5.0
            const colors = ["white", "yellow", "red", "orange", "blue", "green", "gray"];
            const counts = { white:0, yellow:0, red:0, orange:0, blue:0, green:0, gray:0 };
            
            // Validate Logic
            errorList.innerHTML = "";
            let hasError = false;

            // In Step 1, let's count colors applied to the string
            // (Functionality to be expanded in 5.1 with coordinates)
            
            // Counter Display
            Object.keys(counts).forEach(color => {
                if (color !== 'gray' && counts[color] > 9) {
                    hasError = true;
                    const div = document.createElement('div');
                    div.textContent = `⚠️ ${color.toUpperCase()} has ${counts[color]} stickers (Max 9)`;
                    errorList.appendChild(div);
                }
            });

            if (hasError) {
                validatorMsg.innerHTML = "<span class='text-red-500'>❌ Invalid Sticker Count</span>";
            } else {
                validatorMsg.innerHTML = "<span class='text-emerald-500'>✅ Valid Sticker Count</span>";
            }
        }

        // --- Move Buttons ---
        const moveGrid = document.getElementById('move-grid');
        ['U','D','L','R','F','B'].forEach(f => {
            const btn = document.createElement('button');
            btn.className = "bg-slate-700 hover:bg-slate-600 p-2 rounded text-[10px] font-mono font-bold";
            btn.textContent = f;
            btn.onclick = () => {
                if(currentMode === 'rotate') {
                    cmdBox.value += (cmdBox.value ? " " : "") + f;
                    player.alg = cmdBox.value;
                }
            };
            moveGrid.appendChild(btn);
        });

        // --- Scramble & Setup ---
        document.getElementById('btn-scramble').onclick = () => {
            if (cmdBox.value === "") {
                // Random Logic
                const faces = ['U','D','L','R','F','B'];
                let s = ""; for(let i=0; i<20; i++) s += faces[Math.floor(Math.random()*6)] + " ";
                cmdBox.value = s.trim();
            }
            player.alg = cmdBox.value;
            updateStickers();
        };

        document.getElementById('btn-reset').onclick = () => {
            cmdBox.value = "";
            player.alg = "";
            customStickering = {};
            updateStickers();
            setMode('rotate');
        };

    </script>
</body>
</html>