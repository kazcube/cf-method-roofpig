<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubik's Cube CF - Unified Stable v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.cubing.net/v0/js/cubing/twisty" type="module"></script>
    <style>
        twisty-player {
            touch-action: none;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 p-4">
    <div class="max-w-5xl mx-auto bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-2xl">
        <header class="mb-4 flex justify-between items-center border-b border-slate-700 pb-2">
            <div class="flex items-baseline gap-2">
                <h2 class="text-xl font-bold text-emerald-400">CF Simulator</h2>
                <span class="text-[10px] font-mono text-slate-500 bg-slate-900 px-2 py-0.5 rounded border border-slate-700">v2.1 SCRAMBLE PATCH</span>
            </div>
            <div id="status" class="text-[10px] font-mono bg-black px-2 py-1 rounded text-emerald-400 border border-emerald-900/50 uppercase tracking-tighter">READY</div>
        </header>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-black rounded-lg aspect-square border border-slate-700 overflow-hidden shadow-inner">
                        <twisty-player id="p1" puzzle="3x3x3" background="checkered" control-panel="none" class="w-full h-full"></twisty-player>
                    </div>
                    <div class="bg-black rounded-lg aspect-square border border-slate-700 overflow-hidden shadow-inner">
                        <twisty-player id="p2" puzzle="3x3x3" background="none" control-panel="none" 
                            experimental-stickering-mask-orbits="EDGES:IIIIIIIIIIII,CORNERS:--------,CENTERS:IIIIII" class="w-full h-full"></twisty-player>
                    </div>
                </div>

                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 shadow-inner space-y-3">
                    <div class="flex justify-between items-center text-xs font-mono text-emerald-500">
                        <span class="bg-emerald-950/50 px-2 py-1 rounded">STEP: <span id="step-counter">0</span></span>
                        <span id="move-indicator" class="text-lg font-bold bg-slate-800 px-3 py-1 rounded border border-slate-700">---</span>
                    </div>
                    <input type="range" id="move-slider" min="0" max="0" value="0" step="1" 
                           class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500 shadow-sm disabled:opacity-30">
                    <div class="bg-black/50 p-2 rounded text-[10px] font-mono text-slate-400 break-all min-h-[3rem] border border-slate-800" id="alg-display">Ready.</div>
                </div>
                
                <div class="flex gap-2">
                    <button id="btn-play" class="flex-[3] bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-bold text-white shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:bg-slate-700" disabled>再生</button>
                    <button id="btn-reset" class="flex-1 bg-red-900/30 text-red-400 rounded-xl text-xs border border-red-900/50 hover:bg-red-900/50 transition-colors">リセット</button>
                </div>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-1.5" id="button-grid">
                    </div>
                <div class="pt-4 border-t border-slate-700 grid grid-cols-2 gap-3">
                    <button id="btn-scramble" class="py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold shadow-xl transition-all active:scale-95 border border-indigo-400/20 text-sm">
                        ランダム<br>スクランブル
                    </button>
                    <button id="btn-setup" class="py-4 bg-amber-500 hover:bg-amber-400 text-slate-900 rounded-xl font-black text-base shadow-xl active:scale-95 transition-all border border-amber-300/30 text-sm">
                        手順を<br>セットアップ
                    </button>
                </div>
                <p class="text-[10px] text-slate-500 text-center uppercase tracking-widest">© 2026 KAZCUBE - Testing Environment</p>
            </div>
        </div>
    </div>

    <script type="module">
        const p1 = document.getElementById('p1');
        const p2 = document.getElementById('p2');
        const algDisplay = document.getElementById('alg-display');
        const status = document.getElementById('status');
        const playBtn = document.getElementById('btn-play');
        const slider = document.getElementById('move-slider');
        const stepCounter = document.getElementById('step-counter');
        const moveIndicator = document.getElementById('move-indicator');
        const buttonGrid = document.getElementById('button-grid');

        let recordedMoves = []; 
        let baseAlg = "";      
        let isSetupMode = false;
        let playInterval = null;

        const render = (step) => {
            const currentPlayMoves = recordedMoves.slice(0, step);
            const totalAlg = (baseAlg + " " + currentPlayMoves.join(" ")).trim();
            p1.alg = totalAlg;
            p2.alg = totalAlg;
            slider.value = step;
            stepCounter.textContent = step;
            moveIndicator.textContent = step > 0 ? recordedMoves[step - 1] : "---";
            if (!isSetupMode) algDisplay.textContent = recordedMoves.join(" ");
        };

        const handleInput = (move) => {
            const currentStep = isSetupMode ? parseInt(slider.value) : recordedMoves.length;
            if (isSetupMode) recordedMoves = recordedMoves.slice(0, currentStep);
            recordedMoves.push(move);
            slider.max = recordedMoves.length;
            render(recordedMoves.length);
        };

        slider.oninput = () => render(parseInt(slider.value));

        playBtn.onclick = () => {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
                playBtn.textContent = "再開";
                playBtn.classList.replace('bg-orange-600', 'bg-emerald-600');
            } else {
                playBtn.textContent = "停止";
                playBtn.classList.replace('bg-emerald-600', 'bg-orange-600');
                playInterval = setInterval(() => {
                    let current = parseInt(slider.value);
                    if (current < recordedMoves.length) {
                        render(current + 1);
                    } else {
                        clearInterval(playInterval);
                        playInterval = null;
                        playBtn.textContent = "再生完了";
                        setTimeout(() => { 
                            playBtn.textContent = "再生"; 
                            playBtn.classList.remove('bg-orange-600');
                            playBtn.classList.add('bg-emerald-600');
                        }, 1500);
                    }
                }, 800);
            }
        };

        ['U','D','L','R','F','B','M','E','S'].forEach(f => {
            [f, f+"'", f+"2"].forEach(move => {
                const btn = document.createElement('button');
                btn.className = "p-2 bg-slate-700 hover:bg-emerald-700 rounded text-sm transition-all active:scale-95 shadow font-mono";
                btn.textContent = move;
                btn.onclick = () => handleInput(move);
                buttonGrid.appendChild(btn);
            });
        });

        document.getElementById('btn-setup').onclick = () => {
            if (recordedMoves.length === 0) return;
            const inverse = [...recordedMoves].reverse().map(m => 
                m.endsWith("2") ? m : (m.endsWith("'") ? m.slice(0, -1) : m + "'")
            );
            baseAlg = inverse.join(" ");
            isSetupMode = true;
            slider.max = recordedMoves.length;
            playBtn.disabled = false;
            render(0); 
            status.textContent = "SETUP COMPLETE";
            algDisplay.textContent = "Setup: " + baseAlg;
        };

        document.getElementById('btn-scramble').onclick = () => {
            const faces = ['U', 'D', 'L', 'R', 'F', 'B'];
            const modifiers = ['', "'", '2'];
            let scramble = [];
            let lastFace = '';
            for (let i = 0; i < 20; i++) {
                let face;
                do { face = faces[Math.floor(Math.random() * faces.length)]; } while (face === lastFace);
                scramble.push(face + modifiers[Math.floor(Math.random() * modifiers.length)]);
                lastFace = face;
            }
            resetAllInternal();
            baseAlg = scramble.join(" ");
            isSetupMode = true;
            render(0);
            status.textContent = "SCRAMBLED";
            algDisplay.textContent = "Scramble: " + baseAlg;
        };

        const resetAllInternal = () => {
            if (playInterval) clearInterval(playInterval);
            playInterval = null;
            baseAlg = ""; recordedMoves = []; isSetupMode = false;
            p1.alg = ""; p2.alg = "";
            slider.value = 0; slider.max = 0;
            playBtn.disabled = true;
            playBtn.textContent = "再生";
            playBtn.className = "flex-[3] bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-bold text-white shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:bg-slate-700";
            algDisplay.textContent = "Ready.";
            status.textContent = "READY";
            stepCounter.textContent = "0";
            moveIndicator.textContent = "---";
        };
        document.getElementById('btn-reset').onclick = resetAllInternal;
    </script>
</body>
</html>