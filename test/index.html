<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubik's Cube CF - Ver 4.0 Single Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.cubing.net/v0/js/cubing/twisty" type="module"></script>
    <style>
        twisty-player { touch-action: none; }
        .command-box {
            background-color: rgba(0, 0, 0, 0.6) !important;
            color: #10b981 !important; /* Emerald-500 */
            padding: 0.75rem !important;
            border-radius: 0.75rem !important;
            font-family: ui-monospace, monospace !important;
            font-size: 12px !important;
            border: 1px solid #334155 !important;
            width: 100% !important;
            outline: none !important;
            transition: all 0.2s;
        }
        .command-box:focus { border-color: #10b981 !important; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 p-4">
    <div class="max-w-5xl mx-auto bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-2xl">
        <header class="mb-6 flex justify-between items-center border-b border-slate-700 pb-3">
            <div class="flex items-baseline gap-3">
                <h2 class="text-2xl font-black text-emerald-400 tracking-tighter">CF SIMULATOR</h2>
                <span class="text-[10px] font-mono text-slate-500 bg-slate-900 px-2 py-0.5 rounded border border-slate-700 uppercase">v4.0 Single_Hub</span>
            </div>
            <div id="status" class="text-xs font-mono bg-emerald-950 text-emerald-400 px-3 py-1 rounded-full border border-emerald-500/30 uppercase tracking-widest">Ready</div>
        </header>

        <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-black rounded-2xl aspect-square border border-slate-700 overflow-hidden shadow-2xl relative">
                        <div class="absolute top-2 left-2 text-[8px] text-slate-500 z-10 font-bold uppercase">Main View</div>
                        <twisty-player id="p1" puzzle="3x3x3" background="checkered" control-panel="none" class="w-full h-full"></twisty-player>
                    </div>
                    <div class="bg-black rounded-2xl aspect-square border border-slate-700 overflow-hidden shadow-2xl relative">
                        <div class="absolute top-2 left-2 text-[8px] text-slate-500 z-10 font-bold uppercase">Target (Edges Only)</div>
                        <twisty-player id="p2" puzzle="3x3x3" background="none" control-panel="none" 
                            experimental-stickering-mask-orbits="EDGES:IIIIIIIIIIII,CORNERS:--------,CENTERS:IIIIII" class="w-full h-full"></twisty-player>
                    </div>
                </div>

                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-700 shadow-inner space-y-4">
                    <div class="flex justify-between items-end">
                        <div class="space-y-1">
                            <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Progress Control</span>
                            <div class="flex items-baseline gap-2">
                                <span class="text-3xl font-black text-emerald-500" id="step-counter">0</span>
                                <span class="text-xs text-slate-500 font-mono">STEPS</span>
                            </div>
                        </div>
                        <div id="move-indicator" class="text-2xl font-mono font-bold text-slate-300 bg-slate-800 px-4 py-1 rounded-lg border border-slate-700">---</div>
                    </div>
                    <input type="range" id="move-slider" min="0" max="0" value="0" step="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500 transition-all disabled:opacity-20">
                    <div class="flex gap-2">
                        <button id="btn-play" class="flex-[3] bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-black text-white shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:grayscale" disabled>PLAY SOLUTION</button>
                        <button id="btn-reset" class="flex-1 bg-slate-800 hover:bg-red-900/40 text-slate-400 hover:text-red-400 rounded-xl text-xs font-bold transition-all border border-slate-700">RESET</button>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Command Box (Input/Output)</label>
                        <span class="text-[9px] text-emerald-600 font-mono animate-pulse">● Live Tracking</span>
                    </div>
                    <textarea id="command-box" class="command-box h-32 resize-none" placeholder="Enter moves or leave empty for random..."></textarea>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-scramble" class="py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold shadow-xl transition-all active:scale-95 border border-indigo-400/20 text-xs uppercase tracking-widest">
                            Scramble
                        </button>
                        <button id="btn-setup-solve" class="py-4 bg-amber-500 hover:bg-amber-400 text-slate-900 rounded-xl font-black text-xs shadow-xl active:scale-95 transition-all border border-amber-300/30 uppercase tracking-tight">
                            Set to Solve
                        </button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Manual Input</label>
                    <div class="grid grid-cols-3 gap-1.5" id="button-grid"></div>
                </div>
                
                <footer class="text-center pt-4 border-t border-slate-700">
                    <p class="text-[10px] text-slate-600 uppercase tracking-[0.3em] font-bold">© 2026 KAZCUBE Labs</p>
                </footer>
            </div>
        </div>
    </div>

    <script type="module">
        const p1 = document.getElementById('p1');
        const p2 = document.getElementById('p2');
        const cmdBox = document.getElementById('command-box');
        const status = document.getElementById('status');
        const playBtn = document.getElementById('btn-play');
        const scrambleBtn = document.getElementById('btn-scramble');
        const setupBtn = document.getElementById('btn-setup-solve');
        const slider = document.getElementById('move-slider');
        const stepCounter = document.getElementById('step-counter');
        const moveIndicator = document.getElementById('move-indicator');
        const buttonGrid = document.getElementById('button-grid');

        let recordedMoves = []; 
        let baseAlg = "";      
        let isSetupMode = false;
        let playInterval = null;

        // --- Core: Rendering ---
        const render = (step) => {
            const currentPlayMoves = recordedMoves.slice(0, step);
            const totalAlg = (baseAlg + " " + currentPlayMoves.join(" ")).trim();
            p1.alg = totalAlg;
            p2.alg = totalAlg;
            slider.value = step;
            stepCounter.textContent = step;
            moveIndicator.textContent = step > 0 ? recordedMoves[step - 1] : "---";
            
            // Only update box if we're not in solver mode (recording live moves)
            if (!isSetupMode) {
                cmdBox.value = recordedMoves.join(" ");
            }
        };

        // --- Inputs ---
        const handleInput = (move) => {
            const currentStep = parseInt(slider.value);
            // If user moves mid-history, truncate
            if (currentStep < recordedMoves.length) {
                recordedMoves = recordedMoves.slice(0, currentStep);
            }
            recordedMoves.push(move);
            slider.max = recordedMoves.length;
            render(recordedMoves.length);
        };

        slider.oninput = () => render(parseInt(slider.value));

        // --- Action: Scramble (As Is) ---
        scrambleBtn.onclick = () => {
            resetState();
            let input = cmdBox.value.trim();
            
            if (input === "") {
                const faces = ['U', 'D', 'L', 'R', 'F', 'B'];
                const mods = ['', "'", '2'];
                let scramble = []; let last = '';
                for (let i = 0; i < 20; i++) {
                    let f; do { f = faces[Math.floor(Math.random()*6)]; } while (f === last);
                    scramble.push(f + mods[Math.floor(Math.random()*3)]);
                    last = f;
                }
                baseAlg = scramble.join(" ");
                cmdBox.value = baseAlg;
            } else {
                baseAlg = input;
            }
            
            isSetupMode = true; // Protect the scramble moves
            render(0);
            status.textContent = "Scrambled";
        };

        // --- Action: Set to Solve (Inverts) ---
        setupBtn.onclick = () => {
            let solveMoves = cmdBox.value.trim().split(/\s+/).filter(x => x.length > 0);
            if (solveMoves.length === 0) return;

            recordedMoves = solveMoves;
            const inverse = [...recordedMoves].reverse().map(m => 
                m.endsWith("2") ? m : (m.endsWith("'") ? m.slice(0, -1) : m + "'")
            );
            baseAlg = inverse.join(" ");
            isSetupMode = true;
            slider.max = recordedMoves.length;
            playBtn.disabled = false;
            render(0); 
            status.textContent = "Solver Ready";
        };

        // --- Action: Playback ---
        playBtn.onclick = () => {
            if (playInterval) {
                clearInterval(playInterval); playInterval = null;
                playBtn.textContent = "Resume";
                playBtn.classList.replace('bg-orange-600', 'bg-emerald-600');
            } else {
                playBtn.textContent = "Stop";
                playBtn.classList.replace('bg-emerald-600', 'bg-orange-600');
                playInterval = setInterval(() => {
                    let current = parseInt(slider.value);
                    if (current < recordedMoves.length) { render(current + 1); }
                    else { 
                        clearInterval(playInterval); playInterval = null; 
                        playBtn.textContent = "Finished";
                        setTimeout(() => { 
                            playBtn.textContent = "Play Solution";
                            playBtn.classList.replace('bg-orange-600', 'bg-emerald-600');
                        }, 1500);
                    }
                }, 800);
            }
        };

        // --- Utility: Reset ---
        const resetState = () => {
            if (playInterval) clearInterval(playInterval);
            playInterval = null;
            baseAlg = ""; recordedMoves = []; isSetupMode = false;
            p1.alg = ""; p2.alg = "";
            slider.value = 0; slider.max = 0;
            playBtn.disabled = true;
            playBtn.textContent = "Play Solution";
            playBtn.className = "flex-[3] bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-black text-white shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:grayscale";
            status.textContent = "Ready";
            stepCounter.textContent = "0";
            moveIndicator.textContent = "---";
        };
        document.getElementById('btn-reset').onclick = () => {
            cmdBox.value = "";
            resetState();
        };

        // Create Buttons
        ['U','D','L','R','F','B','M','E','S'].forEach(f => {
            [f, f+"'", f+"2"].forEach(move => {
                const btn = document.createElement('button');
                btn.className = "p-2 bg-slate-700 hover:bg-emerald-700 rounded text-sm transition-all active:scale-95 shadow font-mono font-bold";
                btn.textContent = move;
                btn.onclick = () => handleInput(move);
                buttonGrid.appendChild(btn);
            });
        });
    </script>
</body>
</html>