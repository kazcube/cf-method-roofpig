<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Rubik's Cube CF - Logic Unified</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.cubing.net/v0/js/cubing/twisty" type="module"></script>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 p-4">
    <div class="max-w-5xl mx-auto bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-2xl">
        <header class="mb-4 flex justify-between items-center border-b border-slate-700 pb-2">
            <h2 class="text-xl font-bold text-emerald-400">CF Simulator (Unified Logic)</h2>
            <div id="status" class="text-[10px] font-mono bg-black px-2 py-1 rounded text-emerald-400">READY</div>
        </header>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-black rounded-lg aspect-square border border-slate-700 overflow-hidden">
                        <twisty-player id="p1" puzzle="3x3x3" background="checkered" control-panel="none" class="w-full h-full"></twisty-player>
                    </div>
                    <div class="bg-black rounded-lg aspect-square border border-slate-700 overflow-hidden">
                        <twisty-player id="p2" puzzle="3x3x3" background="none" control-panel="none" 
                            experimental-stickering-mask-orbits="EDGES:IIIIIIIIIIII,CORNERS:--------,CENTERS:IIIIII" class="w-full h-full"></twisty-player>
                    </div>
                </div>

                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 space-y-3">
                    <div class="flex justify-between text-xs font-mono text-emerald-500">
                        <span>STEP: <span id="step-counter">0</span></span>
                        <span id="move-indicator">---</span>
                    </div>
                    <input type="range" id="move-slider" min="0" max="0" value="0" step="1" 
                           class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                    <div class="bg-black/50 p-2 rounded text-[10px] font-mono text-slate-400 break-all min-h-[2.5rem]" id="alg-display">Ready.</div>
                </div>
                
                <div class="flex gap-2">
                    <button id="btn-play" class="flex-[3] bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold text-white shadow-lg transition-all active:scale-95 disabled:opacity-50" disabled>再生</button>
                    <button id="btn-reset" class="flex-1 bg-red-900/30 text-red-400 rounded-xl text-xs border border-red-900/50">リセット</button>
                </div>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-1" id="button-grid"></div>
                <div class="pt-4 border-t border-slate-700">
                    <button id="btn-setup" class="w-full py-4 bg-amber-500 hover:bg-amber-400 text-slate-900 rounded-xl font-black text-base shadow-xl active:scale-95">
                        上記の手順でセットアップ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const p1 = document.getElementById('p1');
        const p2 = document.getElementById('p2');
        const algDisplay = document.getElementById('alg-display');
        const status = document.getElementById('status');
        const playBtn = document.getElementById('btn-play');
        const slider = document.getElementById('move-slider');
        const stepCounter = document.getElementById('step-counter');
        const moveIndicator = document.getElementById('move-indicator');
        const buttonGrid = document.getElementById('button-grid');

        let recordedMoves = []; 
        let baseAlg = "";      
        let isSetupMode = false;

        // 全ての描画を司るコア関数
        const render = (step) => {
            // 表示する手の配列を切り出す
            const currentPlayMoves = recordedMoves.slice(0, step);
            // 土台（崩し） + 現在の手順 を結合
            const totalAlg = (baseAlg + " " + currentPlayMoves.join(" ")).trim();
            
            // キューブに反映
            p1.alg = totalAlg;
            p2.alg = totalAlg;
            
            // UIの状態を同期
            slider.value = step;
            stepCounter.textContent = step;
            moveIndicator.textContent = step > 0 ? recordedMoves[step - 1] : "---";
            
            // セットアップ前なら、全手順を表示領域に出す
            if (!isSetupMode) {
                algDisplay.textContent = recordedMoves.join(" ");
            }
        };

        const handleInput = (move) => {
            if (isSetupMode) {
                // セットアップ後の場合：現在のスライダー位置より先を上書き
                const currentStep = parseInt(slider.value);
                recordedMoves = recordedMoves.slice(0, currentStep);
                recordedMoves.push(move);
                slider.max = recordedMoves.length;
                render(recordedMoves.length);
            } else {
                // 通常入力の場合
                recordedMoves.push(move);
                slider.max = recordedMoves.length;
                render(recordedMoves.length);
            }
        };

        slider.oninput = () => render(parseInt(slider.value));

        let playInterval = null;
        playBtn.onclick = () => {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
                playBtn.textContent = "再開";
                playBtn.classList.replace('bg-orange-600', 'bg-emerald-600');
            } else {
                playBtn.textContent = "停止";
                playBtn.classList.replace('bg-emerald-600', 'bg-orange-600');
                playInterval = setInterval(() => {
                    let current = parseInt(slider.value);
                    if (current < recordedMoves.length) {
                        render(current + 1);
                    } else {
                        clearInterval(playInterval);
                        playInterval = null;
                        playBtn.textContent = "再生";
                        playBtn.classList.replace('bg-orange-600', 'bg-emerald-600');
                    }
                }, 800);
            }
        };

        ['U','D','L','R','F','B','M','E','S'].forEach(f => {
            [f, f+"'", f+"2"].forEach(move => {
                const btn = document.createElement('button');
                btn.className = "p-2 bg-slate-700 hover:bg-emerald-700 rounded text-sm transition-all active:scale-95 shadow";
                btn.textContent = move;
                btn.onclick = () => handleInput(move);
                buttonGrid.appendChild(btn);
            });
        });

        document.getElementById('btn-setup').onclick = () => {
            if (recordedMoves.length === 0) return;
            const inverse = [...recordedMoves].reverse().map(m => 
                m.endsWith("2") ? m : (m.endsWith("'") ? m.slice(0, -1) : m + "'")
            );

            baseAlg = inverse.join(" ");
            isSetupMode = true;
            
            slider.max = recordedMoves.length;
            playBtn.disabled = false;
            
            render(0); // 0ステップ目（崩れただけの状態）に戻す
            status.textContent = "SETUP COMPLETE";
            algDisplay.textContent = "再生準備完了: " + recordedMoves.join(" ");
        };

        document.getElementById('btn-reset').onclick = () => {
            if (playInterval) clearInterval(playInterval);
            playInterval = null;
            baseAlg = ""; recordedMoves = []; isSetupMode = false;
            p1.alg = ""; p2.alg = "";
            slider.value = 0;
            slider.max = 0;
            playBtn.disabled = true;
            playBtn.textContent = "再生";
            playBtn.className = "flex-[3] bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold text-white shadow-lg transition-all active:scale-95 disabled:opacity-50";
            algDisplay.textContent = "Ready.";
            status.textContent = "READY";
            stepCounter.textContent = "0";
            moveIndicator.textContent = "---";
        };
    </script>
</body>
</html>