<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAZCUBE Lab - Ver 5.10 Clear Canvas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.cubing.net/v0/js/cubing/twisty" type="module"></script>
    <style>
        twisty-player { touch-action: none; width: 100%; height: 100%; }
        .main-grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; align-items: start; }
        @media (max-width: 800px) { .main-grid { grid-template-columns: 1fr 300px; gap: 12px; } }
        .move-btn { @apply bg-slate-700 active:bg-indigo-600 text-white py-1.5 rounded text-[10px] font-mono font-bold border border-slate-600 transition-all; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .accordion-content.open { max-height: 800px; }
        
        /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
        .color-dot { @apply w-8 h-8 rounded-full border-2 border-slate-700 cursor-pointer transition-all hover:scale-110 relative; }
        .color-dot.active { @apply border-white scale-110 shadow-[0_0_15px_rgba(255,255,255,0.8)]; }
        .color-dot.active::after { content: 'âœ“'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: black; font-weight: bold; font-size: 14px; }

        /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆALL CLEAR / CORNERSï¼‰ */
        .template-btn { @apply flex-1 py-3 text-xs font-black rounded-xl border-2 transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2; }
        /* ALL CLEAR: ã‚°ãƒ¬ãƒ¼ãƒ™ãƒ¼ã‚¹ */
        .template-btn[data-type="clear"] { @apply bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-600; }
        .template-btn[data-type="clear"].active { @apply bg-slate-500 border-white text-white shadow-[0_0_15px_rgba(255,255,255,0.3)]; }
        /* CORNERS: ã‚ªãƒ¬ãƒ³ã‚¸ãƒ™ãƒ¼ã‚¹ */
        .template-btn[data-type="corners"] { @apply bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700; }
        .template-btn[data-type="corners"].active { @apply bg-orange-600 border-orange-400 text-white; }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 p-4 lg:p-6 overflow-x-auto font-sans">
    <div class="min-w-[750px] max-w-[1400px] mx-auto">
        
        <header class="mb-6 flex justify-between items-center border-b border-slate-700 pb-4">
            <div class="flex items-baseline gap-3">
                <h2 class="text-2xl font-black text-emerald-400 italic">KAZCUBE Lab</h2>
                <span class="text-[10px] font-mono text-slate-500 px-2 py-0.5 border border-slate-700 rounded uppercase tracking-widest">v5.10 Canvas Mode</span>
            </div>
            <div id="mode-badge" class="text-[10px] font-mono bg-blue-900 text-blue-200 px-4 py-1 rounded-full border border-blue-500/30 uppercase tracking-[0.2em]">Rotate Mode</div>
        </header>

        <div class="main-grid">
            <div class="space-y-4">
                <div class="bg-black rounded-3xl aspect-square border-4 border-slate-700 overflow-hidden shadow-2xl relative">
                    <twisty-player id="main-cube" puzzle="3x3x3" background="none" control-panel="none"></twisty-player>
                </div>

                <div class="bg-slate-800/50 p-6 rounded-3xl border border-slate-700 shadow-xl space-y-4">
                    <input type="range" id="move-slider" min="0" max="0" value="0" step="1" class="w-full h-2.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                    <div class="flex justify-between items-center">
                        <div class="flex flex-col"><span class="text-slate-500 text-[10px] uppercase">Step</span><span id="step-counter" class="text-emerald-500 text-2xl font-bold">0</span></div>
                        <div id="move-indicator" class="text-xl font-mono font-black bg-slate-900 px-6 py-1 rounded-xl text-emerald-400 border border-slate-700 italic">---</div>
                    </div>
                </div>
            </div>

            <div class="space-y-6 pb-20">
                <div class="flex bg-slate-950 p-1.5 rounded-2xl border border-slate-700 shadow-xl">
                    <button id="mode-rotate" class="flex-1 py-3 rounded-xl text-xs font-black transition-all bg-emerald-600 text-white shadow-lg">ROTATE</button>
                    <button id="mode-paint" class="flex-1 py-3 rounded-xl text-xs font-black text-slate-500 hover:text-white transition-all">PAINT</button>
                </div>

                <div id="paint-panel" class="hidden space-y-5 p-5 bg-slate-900 rounded-2xl border-2 border-orange-500/20 shadow-inner">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest px-1">1. Reset View</label>
                        <div class="flex gap-3">
                            <button class="template-btn active" data-type="clear">â¬œ ALL GRAY</button>
                            <button class="template-btn" data-type="corners">ðŸ§© CORNERS</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest px-1">2. Pick Color to Reveal</label>
                        <div class="flex flex-wrap justify-center gap-3 p-4 bg-black/40 rounded-xl border border-slate-700 shadow-inner">
                            <div class="color-dot bg-white" data-color="white"></div>
                            <div class="color-dot bg-yellow-400" data-color="yellow"></div>
                            <div class="color-dot bg-red-500" data-color="red"></div>
                            <div class="color-dot bg-orange-500" data-color="orange"></div>
                            <div class="color-dot bg-blue-500" data-color="blue"></div>
                            <div class="color-dot bg-green-500" data-color="green"></div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <textarea id="command-box" class="w-full h-28 bg-black/60 text-emerald-400 p-4 rounded-2xl font-mono text-xs border border-slate-700 outline-none focus:border-indigo-500 shadow-inner resize-none" placeholder="Enter sequence..."></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-scramble" class="py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold text-xs uppercase tracking-widest active:scale-95 transition-all shadow-lg">Scramble</button>
                        <button id="btn-reset" class="py-3 bg-slate-700 hover:bg-red-900 text-slate-300 rounded-xl font-bold text-xs uppercase border border-slate-600 transition-all">Reset All</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="border border-slate-700 rounded-2xl overflow-hidden bg-slate-900/40">
                        <button class="accordion-toggle w-full flex justify-between items-center p-4 text-[10px] font-black uppercase tracking-widest hover:bg-slate-800" data-target="basic-moves">
                            <span>Basic Layer</span><span class="icon">â–¼</span>
                        </button>
                        <div id="basic-moves" class="accordion-content open"><div class="grid grid-cols-4 gap-1.5 p-4" id="grid-basic"></div></div>
                    </div>
                    <div class="border border-slate-700 rounded-2xl overflow-hidden bg-slate-900/40">
                        <button class="accordion-toggle w-full flex justify-between items-center p-4 text-[10px] font-black uppercase tracking-widest hover:bg-slate-800" data-target="wide-moves">
                            <span>Wide & Middle</span><span class="icon">â–¼</span>
                        </button>
                        <div id="wide-moves" class="accordion-content"><div class="grid grid-cols-4 gap-1.5 p-4" id="grid-wide"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const player = document.getElementById('main-cube');
            const badge = document.getElementById('mode-badge');
            const paintPanel = document.getElementById('paint-panel');
            const cmdBox = document.getElementById('command-box');
            const slider = document.getElementById('move-slider');
            
            let moves = [];
            let currentMode = 'rotate';
            let currentTemplate = 'clear'; 
            let selectedColor = null;

            // --- 1. Mode Logic ---
            const switchMode = (mode) => {
                currentMode = mode;
                const isPaint = mode === 'paint';

                badge.textContent = isPaint ? "Paint Mode (Analysis)" : "Rotate Mode";
                badge.className = isPaint 
                    ? "text-[10px] font-mono bg-orange-900 text-orange-200 px-4 py-1 rounded-full border border-orange-500/30 uppercase tracking-[0.2em]"
                    : "text-[10px] font-mono bg-blue-900 text-blue-200 px-4 py-1 rounded-full border border-blue-500/30 uppercase tracking-[0.2em]";

                document.getElementById('mode-rotate').className = isPaint ? "flex-1 py-3 rounded-xl text-xs font-black text-slate-500 hover:text-white" : "flex-1 py-3 rounded-xl text-xs font-black bg-emerald-600 text-white shadow-lg";
                document.getElementById('mode-paint').className = isPaint ? "flex-1 py-3 rounded-xl text-xs font-black bg-orange-600 text-white shadow-lg" : "flex-1 py-3 rounded-xl text-xs font-black text-slate-500 hover:text-white";

                paintPanel.style.display = isPaint ? "block" : "none";

                if (isPaint) applyTemplate(currentTemplate);
                else player.experimentalStickeringMaskOrbits = "";
            };

            document.getElementById('mode-rotate').onclick = () => switchMode('rotate');
            document.getElementById('mode-paint').onclick = () => switchMode('paint');

            // --- 2. Mask Logic (ALL GRAY & PICK COLOR) ---
            const applyTemplate = (type) => {
                currentTemplate = type;
                let mask = "";

                if (type === 'clear') {
                    // ALL GRAY: ã‚¨ãƒƒã‚¸ãƒ»ã‚³ãƒ¼ãƒŠãƒ¼å…¨ã¦æ¶ˆã™ï¼ˆã‚»ãƒ³ã‚¿ãƒ¼ã®ã¿æ®‹ã™ï¼‰
                    mask = "EDGES:------------,CORNERS:--------,CENTERS:IIIIII";
                } else if (type === 'corners') {
                    // CORNERS: ã‚³ãƒ¼ãƒŠãƒ¼ã‚’è¡¨ç¤º
                    mask = "EDGES:------------,CORNERS:IIIIIIII,CENTERS:IIIIII";
                }

                // è‰²é¸æŠžãŒã‚ã‚‹å ´åˆã€ç‰¹å®šã®è‰²ã®ãƒ‘ãƒ¼ãƒ„ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«èª¿æ•´
                // â€»ç¾åœ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ©Ÿèƒ½ã§ã¯ã€ŒæŒ‡å®šã—ãŸè‰²ã ã‘ã€ã‚’å‹•çš„ã«åˆ¤å®šã™ã‚‹ã®ãŒé›£ã—ã„ãŸã‚ã€
                // å°†æ¥çš„ã«ã¯å€‹åˆ¥ã®ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«ç™ºå±•ã•ã›ã¾ã™ã€‚
                player.experimentalStickeringMaskOrbits = mask;

                document.querySelectorAll('.template-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === type);
                });
                const tmp = player.alg; player.alg = tmp;
            };

            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.onclick = (e) => {
                    selectedColor = null; // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã¯è‰²é¸æŠžãƒªã‚»ãƒƒãƒˆ
                    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                    applyTemplate(e.currentTarget.dataset.type);
                };
            });

            document.querySelectorAll('.color-dot').forEach(dot => {
                dot.onclick = (e) => {
                    const color = e.currentTarget.dataset.color;
                    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                    
                    if (selectedColor === color) {
                        selectedColor = null;
                        applyTemplate(currentTemplate);
                    } else {
                        selectedColor = color;
                        e.currentTarget.classList.add('active');
                        // ã“ã“ã§å°†æ¥çš„ã«ã€Œãã®è‰²ã ã‘ã‚’è¡¨ç¤ºã€ã™ã‚‹ãƒžã‚¹ã‚¯ã‚’è¨ˆç®—
                        // ç¾åœ¨ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å†é©ç”¨
                        applyTemplate(currentTemplate);
                    }
                };
            });

            // --- 3. Base Engine ---
            const render = (step) => {
                player.alg = moves.slice(0, step).join(" ");
                slider.value = step;
                document.getElementById('step-counter').textContent = step;
                document.getElementById('move-indicator').textContent = step > 0 ? moves[step-1] : "---";
                if (currentMode === 'rotate') cmdBox.value = moves.join(" ");
            };

            const handleMove = (m) => {
                const step = parseInt(slider.value);
                if (step < moves.length) moves = moves.slice(0, step);
                moves.push(m);
                slider.max = moves.length;
                render(moves.length);
            };

            const createBtns = (id, faces) => {
                const grid = document.getElementById(id);
                faces.forEach(f => {
                    [f, f+"'", f+"2"].forEach(m => {
                        const b = document.createElement('button');
                        b.className = "move-btn"; b.textContent = m;
                        b.onclick = () => handleMove(m);
                        grid.appendChild(b);
                    });
                });
            };
            createBtns('grid-basic', ['U','D','L','R','F','B']);
            createBtns('grid-wide', ['u','d','l','r','f','b','M','E','S','x','y','z']);

            slider.oninput = () => render(parseInt(slider.value));
            document.getElementById('btn-reset').onclick = () => {
                moves = []; slider.max = 0; cmdBox.value = ""; player.alg = "";
                switchMode('rotate'); render(0);
            };

            document.getElementById('btn-scramble').onclick = () => {
                if(cmdBox.value) moves = cmdBox.value.split(/\s+/).filter(x => x.length > 0);
                else moves = Array.from({length:20}, () => ['U','D','L','R','F','B'][Math.floor(Math.random()*6)] + (Math.random() > 0.6 ? "2" : (Math.random() > 0.3 ? "'" : "")));
                slider.max = moves.length; render(moves.length);
            };

            document.querySelectorAll('.accordion-toggle').forEach(btn => {
                btn.onclick = () => {
                    const target = document.getElementById(btn.dataset.target);
                    target.classList.toggle('open');
                    btn.querySelector('.icon').textContent = target.classList.contains('open') ? 'â–²' : 'â–¼';
                };
            });
        });
    </script>
</body>
</html>